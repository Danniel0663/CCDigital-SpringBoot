<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ingreso de Usuario · CCDigital</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/css/ccdigital.css">
</head>

<body class="bg-body-tertiary">
<nav class="navbar cc-navbar">
  <div class="container d-flex justify-content-between align-items-center">
    <span class="navbar-brand fw-semibold cc-brand">
      <i class="bi bi-person-badge me-2"></i>CCDigital · Usuario
    </span>
  </div>
</nav>

<main class="container py-5">
  <div class="row justify-content-center">
    <div class="col-12 col-md-8 col-lg-6">
      <div class="cc-card p-4 p-md-5">
        <h1 class="h4 mb-1">Ingreso de Usuario</h1>

        <div class="mb-3">
          <label for="email" class="form-label">Correo</label>
          <input id="email" class="form-control" type="email" autocomplete="username"
                 placeholder="correo@ejemplo.com" />
        </div>

        <div class="mb-3">
          <label for="password" class="form-label">Clave</label>
          <input id="password" class="form-control" type="password" autocomplete="current-password"
                 placeholder="Tu clave" />
        </div>

        <button id="btnStart" class="btn btn-primary w-100">
          <i class="bi bi-shield-check me-2"></i>Validar con credencial
        </button>

        <div id="status" class="mt-3 small text-muted"></div>

        <div class="mt-3 text-center">
          <a href="/register/user" class="small text-decoration-none">
            No tengo cuenta. Registrarme
          </a> 
          <span class="mx-2 text-muted">|</span>
		  <a href="/login/user/forgot" class="small text-decoration-none">
		    Olvidé mi contraseña
		  </a>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  async function postJson(url, data) {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    if (!res.ok) {
      const txt = await res.text();
      throw new Error('HTTP ' + res.status + ' - ' + txt);
    }
    return res.json();
  }

  async function getJson(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return res.json();
  }

  const btn = document.getElementById('btnStart');
  const statusEl = document.getElementById('status');
  const emailEl = document.getElementById('email');
  const passwordEl = document.getElementById('password');

  function setStatus(msg) {
    statusEl.textContent = msg;
  }

  btn.addEventListener('click', async () => {
    try {
      const email = (emailEl.value || '').trim();
      const password = passwordEl.value || '';
      if (!email) {
        setStatus('Ingresa tu correo.');
        return;
      }
      if (!password.trim()) {
        setStatus('Ingresa tu clave.');
        return;
      }

      setStatus('Validando correo y clave...');
      const startRes = await postJson('/user/auth/start', { email, password });

      const presExId = startRes.presExId;
      setStatus('Solicitud enviada. Esperando verificación...');

      let tries = 0;
      const maxTries = 30;

      const timer = setInterval(async () => {
        tries++;
        try {
          const pollRes = await getJson('/user/auth/poll?presExId=' + encodeURIComponent(presExId));
          if (pollRes.authenticated) {
            clearInterval(timer);
            setStatus('Verificado. Redirigiendo...');
            window.location.href = pollRes.redirectUrl || '/user/dashboard';
            return;
          }

          if (tries >= maxTries) {
            clearInterval(timer);
            setStatus('Tiempo de espera agotado. Intenta de nuevo.');
            return;
          }

          setStatus('Aún no verificado. Estado: ' + (pollRes.state || '...'));
        } catch (e) {
          clearInterval(timer);
          setStatus('Error consultando estado: ' + e.message);
        }
      }, 700);

    } catch (e) {
      setStatus('Error: ' + e.message);
    }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>