<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ingreso de Usuario · CCDigital</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/css/ccdigital.css">

  <!-- CSRF para llamadas fetch del flujo start/poll/otp -->
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<body class="bg-body-tertiary">
<nav class="navbar cc-navbar">
  <div class="container d-flex justify-content-between align-items-center">
    <a href="/" class="navbar-brand fw-semibold cc-brand text-decoration-none">
      <i class="bi bi-person-badge me-2"></i>CCDigital · Usuario
    </a>
    <a href="/" class="btn btn-sm btn-outline-secondary cc-nav-action-btn">
      <i class="bi bi-house me-1"></i>Inicio
    </a>
  </div>
</nav>

<main class="container py-5">
  <div class="row justify-content-center">
    <div class="col-12 col-md-8 col-lg-6">
      <div class="cc-card p-4 p-md-5">
        <h1 class="h4 mb-2">Ingreso de Usuario</h1>
        <p class="cc-help-text small mb-3">
          Ingresa con tu correo y contraseña. Luego se validará tu credencial digital automáticamente.
        </p>

        <div class="mb-3">
          <label for="email" class="form-label">Correo</label>
          <input id="email" class="form-control" type="email" autocomplete="username"
                 placeholder="correo@ejemplo.com" />
          <div class="form-text">Usa el correo con el que registraste tu cuenta.</div>
        </div>

        <div class="mb-3">
          <label for="password" class="form-label">Clave</label>
          <input id="password" class="form-control" type="password" autocomplete="current-password"
                 placeholder="Tu clave" />
        </div>

        <div id="otpSection" class="cc-form-section d-none mb-3">
          <div class="cc-section-title">
            <i class="bi bi-shield-lock"></i>Verificación adicional
          </div>
          <p id="otpHelp" class="small text-muted mb-2">
            Ingresa el código de verificación.
          </p>
          <label for="otpCode" class="form-label">Código de verificación</label>
          <input id="otpCode" class="form-control" type="text" inputmode="numeric" maxlength="8"
                 autocomplete="one-time-code" placeholder="Código de 6 dígitos" />
          <button id="btnOtpVerify" type="button" class="btn btn-outline-primary w-100 mt-2">
            <i class="bi bi-check2-circle me-2"></i>Validar código
          </button>
          <button id="btnOtpResend" type="button" class="btn btn-link w-100 mt-1 d-none">
            Reenviar código al correo
          </button>
        </div>

        <button id="btnStart" class="btn btn-primary w-100">
          <i class="bi bi-shield-check me-2"></i>Ingresar y validar credencial
        </button>

        <div id="statusBox" class="cc-status-box alert py-2 mt-3 mb-0" role="status" aria-live="polite">
          <span id="statusText">Estado</span>
        </div>

        <div class="mt-3 text-center">
          <a href="/register/user" class="small text-decoration-none">
            No tengo cuenta. Registrarme
          </a> 
          <span class="mx-2 text-muted">|</span>
		  <a href="/login/user/forgot" class="small text-decoration-none">
		    Olvidé mi contraseña
		  </a>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  let pollTimer = null;
  let currentPresExId = null;

  function extractErrorMessage(status, text) {
    if (!text) return 'Ocurrió un error inesperado.';
    try {
      const data = JSON.parse(text);
      if (data && typeof data.error === 'string' && data.error.trim()) {
        return data.error.trim();
      }
      if (data && typeof data.message === 'string' && data.message.trim()) {
        return data.message.trim();
      }
    } catch (_) {}
    return text.replace(/\s+/g, ' ').trim() || ('Error HTTP ' + status);
  }

  function csrf() {
    const token = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || '';
    const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || 'X-CSRF-TOKEN';
    return { token, header };
  }

  async function postJson(url, data) {
    const { token, header } = csrf();
    const headers = { 'Content-Type': 'application/json' };
    if (token) headers[header] = token;
    const res = await fetch(url, {
      method: 'POST',
      credentials: 'same-origin',
      headers,
      body: JSON.stringify(data)
    });
    if (!res.ok) {
      const txt = await res.text();
      throw new Error(extractErrorMessage(res.status, txt));
    }
    return res.json();
  }

  async function getJson(url) {
    const res = await fetch(url, { credentials: 'same-origin' });
    if (!res.ok) {
      const txt = await res.text();
      throw new Error(extractErrorMessage(res.status, txt));
    }
    return res.json();
  }

  const btn = document.getElementById('btnStart');
  const statusBoxEl = document.getElementById('statusBox');
  const statusTextEl = document.getElementById('statusText');
  const emailEl = document.getElementById('email');
  const passwordEl = document.getElementById('password');
  const otpSectionEl = document.getElementById('otpSection');
  const otpHelpEl = document.getElementById('otpHelp');
  const otpCodeEl = document.getElementById('otpCode');
  const btnOtpVerify = document.getElementById('btnOtpVerify');
  const btnOtpResend = document.getElementById('btnOtpResend');

  function setStatus(msg, tone = 'info') {
    statusTextEl.textContent = msg;
    statusBoxEl.className = 'cc-status-box is-visible alert py-2 mt-3 mb-0';
    if (tone === 'success') statusBoxEl.classList.add('alert-success');
    else if (tone === 'warning') statusBoxEl.classList.add('alert-warning');
    else if (tone === 'danger') statusBoxEl.classList.add('alert-danger');
    else statusBoxEl.classList.add('alert-info');
  }

  function setBusy(isBusy, label) {
    btn.disabled = isBusy;
    if (isBusy) {
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>' + (label || 'Procesando...');
    } else {
      btn.innerHTML = '<i class="bi bi-shield-check me-2"></i>Ingresar y validar credencial';
    }
  }

  function setOtpBusy(isBusy) {
    btnOtpVerify.disabled = isBusy;
    if (isBusy) {
      btnOtpVerify.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Validando código...';
    } else {
      btnOtpVerify.innerHTML = '<i class="bi bi-check2-circle me-2"></i>Validar código';
    }
  }

  function showOtpSection(options) {
    const method = (options && options.method) ? String(options.method).toLowerCase() : 'email';
    const maskedEmail = options && options.maskedEmail ? options.maskedEmail : '';
    otpSectionEl.classList.remove('d-none');
    btn.classList.add('d-none');
    otpHelpEl.textContent = method === 'totp'
      ? 'Ingresa el código generado en tu app de autenticación (Aegis, Google Authenticator o Microsoft Authenticator).'
      : (maskedEmail
          ? ('Ingresa el código que enviamos a ' + maskedEmail + '.')
          : 'Ingresa el código que enviamos a tu correo.');
    otpCodeEl.focus();
    btnOtpResend.classList.toggle('d-none', method !== 'email');
  }

  function resetOtpSection() {
    otpSectionEl.classList.add('d-none');
    btn.classList.remove('d-none');
    otpCodeEl.value = '';
    btnOtpResend.classList.add('d-none');
  }

  (function showUrlMessages() {
    const params = new URLSearchParams(window.location.search);
    if (params.has('logout')) {
      setStatus('Sesión cerrada correctamente.', 'success');
      return;
    }
    if (params.has('expired')) {
      setStatus('Tu sesión expiró. Ingresa nuevamente.', 'warning');
      return;
    }
    if (params.has('denied')) {
      setStatus('No tienes permisos para acceder a esa página.', 'warning');
      return;
    }
  })();

  btn.addEventListener('click', async () => {
    try {
      if (pollTimer) {
        clearInterval(pollTimer);
        pollTimer = null;
      }
      const email = (emailEl.value || '').trim();
      const password = passwordEl.value || '';
      if (!email) {
        setStatus('Ingresa tu correo.', 'warning');
        return;
      }
      if (!password.trim()) {
        setStatus('Ingresa tu clave.', 'warning');
        return;
      }

      window.CCDigitalLoader?.show('Validando datos y preparando verificación...');
      setBusy(true, 'Validando...');
      resetOtpSection();
      currentPresExId = null;
      setStatus('Validando correo y clave...', 'info');
      const startRes = await postJson('/user/auth/start', { email, password });

      const presExId = startRes.presExId;
      currentPresExId = presExId;
      setStatus('Solicitud enviada. Esperando verificación de credencial...', 'info');

      let tries = 0;
      const maxTries = 30;

      pollTimer = setInterval(async () => {
        tries++;
        try {
          const pollRes = await getJson('/user/auth/poll?presExId=' + encodeURIComponent(presExId));
          if (pollRes.otpRequired) {
            clearInterval(pollTimer);
            pollTimer = null;
            setBusy(false);
            window.CCDigitalLoader?.hide(true);
            showOtpSection({ method: pollRes.otpMethod || 'email', maskedEmail: pollRes.maskedEmail || '' });
            setStatus(pollRes.message || 'Se envió un código de verificación al correo.', 'info');
            return;
          }

          if (pollRes.authenticated) {
            clearInterval(pollTimer);
            pollTimer = null;
            window.CCDigitalLoader?.update('Ingreso validado. Redirigiendo...');
            setStatus('Verificación completa. Redirigiendo...', 'success');
            window.location.href = pollRes.redirectUrl || '/user/dashboard';
            return;
          }

          if (tries >= maxTries) {
            clearInterval(pollTimer);
            pollTimer = null;
            setBusy(false);
            window.CCDigitalLoader?.hide(true);
            setStatus('Se agotó el tiempo de espera. Intenta nuevamente.', 'warning');
            return;
          }

          window.CCDigitalLoader?.update('Verificando credencial digital...');
          setStatus('Estamos verificando tu credencial. Estado: ' + (pollRes.state || '...'), 'info');
        } catch (e) {
          clearInterval(pollTimer);
          pollTimer = null;
          setBusy(false);
          window.CCDigitalLoader?.hide(true);
          setStatus(e.message || 'No pudimos consultar el estado de verificación.', 'danger');
        }
      }, 700);

    } catch (e) {
      window.CCDigitalLoader?.hide(true);
      setBusy(false);
      setStatus(e.message || 'No fue posible iniciar la validación.', 'danger');
    }
  });

  btnOtpVerify.addEventListener('click', async () => {
    try {
      window.CCDigitalLoader?.show('Validando código de seguridad...');
      const code = (otpCodeEl.value || '').trim();
      if (!currentPresExId) {
        resetOtpSection();
        window.CCDigitalLoader?.hide(true);
        setStatus('La sesión de validación expiró. Inicia nuevamente.', 'warning');
        return;
      }
      if (!code) {
        window.CCDigitalLoader?.hide(true);
        setStatus('Ingresa el código de verificación.', 'warning');
        return;
      }

      setOtpBusy(true);
      setStatus('Validando código de verificación...', 'info');
      const res = await postJson('/user/auth/otp/verify', { presExId: currentPresExId, code });

      if (res.authenticated) {
        window.CCDigitalLoader?.update('Ingreso confirmado. Redirigiendo...');
        setStatus('Verificación completa. Redirigiendo...', 'success');
        window.location.href = res.redirectUrl || '/user/dashboard';
        return;
      }

      window.CCDigitalLoader?.hide(true);
      setStatus('No fue posible validar el código.', 'danger');
    } catch (e) {
      window.CCDigitalLoader?.hide(true);
      const msg = (e.message || '').toLowerCase();
      const mustRestart = msg.includes('agotaron los intentos')
        || msg.includes('sesión de validación expiró')
        || msg.includes('iniciar sesión nuevamente');
      if (mustRestart) {
        resetOtpSection();
        currentPresExId = null;
      }
      setStatus(e.message || 'No fue posible validar el código.', 'danger');
    } finally {
      setOtpBusy(false);
    }
  });

  btnOtpResend.addEventListener('click', async () => {
    try {
      if (!currentPresExId) {
        setStatus('La sesión de validación expiró. Inicia nuevamente.', 'warning');
        return;
      }
      btnOtpResend.disabled = true;
      window.CCDigitalLoader?.show('Reenviando código...');
      const r = await postJson('/user/auth/otp/resend', { presExId: currentPresExId });
      window.CCDigitalLoader?.hide(true);
      setStatus(r.message || 'Si aplica, se reenvió el código al correo.', 'info');
    } catch (e) {
      window.CCDigitalLoader?.hide(true);
      setStatus(e.message || 'No fue posible reenviar el código.', 'danger');
    } finally {
      btnOtpResend.disabled = false;
    }
  });
</script>

<script src="/js/ccdigital-loader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
