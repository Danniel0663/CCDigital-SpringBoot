<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Recuperar contraseña · CCDigital</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/css/ccdigital.css">

  <!-- CSRF (para fetch) -->
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<body class="bg-body-tertiary">
<nav class="navbar cc-navbar">
  <div class="container d-flex justify-content-between align-items-center">
    <span class="navbar-brand fw-semibold cc-brand">
      <i class="bi bi-key me-2"></i>CCDigital · Recuperar contraseña
    </span>
  </div>
</nav>

<main class="container py-5">
  <div class="row justify-content-center">
    <div class="col-12 col-md-8 col-lg-6">
      <div class="cc-card p-4 p-md-5">

        <h1 class="h4 mb-2">Recuperar contraseña</h1>
        <p class="cc-help-text small mb-3">
          Valida tus datos y recibe un código temporal en tu correo para restablecer la contraseña.
        </p>

        <div class="cc-hero mb-3">
          <div class="fw-semibold small mb-2">
            <i class="bi bi-list-check me-1"></i>Pasos
          </div>
          <ol class="cc-help-list small">
            <li>Ingresa tu correo y datos del documento.</li>
            <li>Recibe un código temporal en tu correo.</li>
            <li>Ingresa el código y crea una nueva contraseña.</li>
          </ol>
        </div>

        <div id="alertBox" class="alert d-none py-2 mb-3"></div>

        <!-- Paso 1: Solicitar código -->
        <div id="step1" class="cc-form-section">
          <div class="cc-section-title">
            <i class="bi bi-envelope-check"></i>Paso 1: Solicitar código de seguridad
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">Correo</label>
            <input id="email" class="form-control" type="email" autocomplete="email"
                   placeholder="correo@ejemplo.com" required />
          </div>

          <div class="mb-3">
            <label for="idType" class="form-label">Tipo de identificación</label>
            <select id="idType" class="form-select" required>
              <option value="">Selecciona una opción</option>
              <option value="CC">CC</option>
              <option value="CE">CE</option>
              <option value="TI">TI</option>
              <option value="PA">PA</option>
              <option value="NIT">NIT</option>
              <option value="PEP">PEP</option>
              <option value="OTRO">OTRO</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="idNumber" class="form-label">Número de identificación</label>
            <input id="idNumber" class="form-control" type="text" inputmode="numeric"
                   placeholder="Ej: 1234567890" required />
          </div>

          <button id="btnVerify" type="button" class="btn btn-primary w-100">
            <i class="bi bi-envelope me-2"></i>Enviar código al correo
          </button>
        </div>

        <!-- Paso 2: Código + nueva contraseña -->
        <div id="step2" class="d-none cc-form-section">
          <div class="cc-section-title">
            <i class="bi bi-key"></i>Paso 2: Ingresa el código y crea nueva contraseña
          </div>
          <div class="alert alert-info py-2 mb-3">
            <i class="bi bi-info-circle me-1"></i>
            Revisa tu correo (incluida la carpeta de spam) e ingresa el código temporal recibido.
          </div>

          <div class="mb-3">
            <label for="resetCode" class="form-label">Código de seguridad</label>
            <input id="resetCode" class="form-control" type="text" inputmode="numeric"
                   maxlength="8" autocomplete="one-time-code"
                   placeholder="Ingresa el código recibido por correo" required />
            <div class="form-text">El código vence en pocos minutos y solo sirve una vez.</div>
          </div>

          <div class="mb-3">
            <label for="newPassword" class="form-label">Nueva contraseña</label>
            <input id="newPassword" class="form-control" type="password" autocomplete="new-password"
                   placeholder="Ingresa tu nueva contraseña" required />
            <div class="form-text">Mínimo 8 caracteres, con letras y números.</div>
          </div>

          <div class="mb-3">
            <label for="confirmPassword" class="form-label">Confirmar contraseña</label>
            <input id="confirmPassword" class="form-control" type="password" autocomplete="new-password"
                   placeholder="Repite tu nueva contraseña" required />
          </div>

          <button id="btnReset" type="button" class="btn btn-primary w-100">
            <i class="bi bi-save me-2"></i>Guardar contraseña
          </button>
        </div>

        <div class="mt-3 text-center">
          <a href="/login/user" class="small text-decoration-none">
            Volver a iniciar sesión
          </a>
        </div>

      </div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Helpers de frontend para el flujo de recuperación por código:
  // - leen CSRF para llamadas fetch
  // - muestran mensajes amigables
  // - hacen POST JSON a endpoints /user/auth/forgot/*
  function csrf() {
    const token = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || '';
    const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || 'X-CSRF-TOKEN';
    return { token, header };
  }

  function showAlert(type, msg) {
    const box = document.getElementById('alertBox');
    box.className = 'alert py-2 mb-3 alert-' + type;
    box.textContent = msg;
    box.classList.remove('d-none');
  }

  function hideAlert() {
    const box = document.getElementById('alertBox');
    box.classList.add('d-none');
    box.textContent = '';
  }

  async function postJson(url, data) {
    const { token, header } = csrf();
    const headers = { 'Content-Type': 'application/json' };
    if (token) headers[header] = token;

    const res = await fetch(url, {
      method: 'POST',
      credentials: 'same-origin',
      headers,
      body: JSON.stringify(data)
    });

    if (!res.ok) {
      const txt = await res.text();
      throw new Error('HTTP ' + res.status + ' - ' + txt);
    }
    return res.json();
  }

  // Estado del flujo:
  // Se conserva la identidad validada (correo + documento) entre el paso 1 y el paso 2.
  let requestPayload = null;

  // Elements
  const step1 = document.getElementById('step1');
  const step2 = document.getElementById('step2');

  const emailEl = document.getElementById('email');
  const idTypeEl = document.getElementById('idType');
  const idNumberEl = document.getElementById('idNumber');

  const newPasswordEl = document.getElementById('newPassword');
  const confirmPasswordEl = document.getElementById('confirmPassword');
  const resetCodeEl = document.getElementById('resetCode');

  const btnVerify = document.getElementById('btnVerify');
  const btnReset = document.getElementById('btnReset');

  // Paso 1: solicita envío de código temporal al correo.
  btnVerify.addEventListener('click', async () => {
    try {
      hideAlert();

      const email = (emailEl.value || '').trim();
      const idType = (idTypeEl.value || '').trim();
      const idNumber = (idNumberEl.value || '').trim();

      if (!email) { showAlert('warning', 'Ingresa tu correo.'); return; }
      if (!idType) { showAlert('warning', 'Selecciona el tipo de identificación.'); return; }
      if (!idNumber) { showAlert('warning', 'Ingresa el número de identificación.'); return; }

      btnVerify.disabled = true;
      btnVerify.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando código...';

      const r = await postJson('/user/auth/forgot/verify', { email, idType, idNumber });

      if (!r.accepted) {
        showAlert('danger', r.message || 'No fue posible enviar el código de recuperación.');
        return;
      }

      requestPayload = { email, idType, idNumber };
      step1.classList.add('d-none');
      step2.classList.remove('d-none');
      showAlert('info', r.message || 'Si los datos coinciden, enviamos un código temporal al correo.');
      resetCodeEl.focus();

    } catch (e) {
      showAlert('danger', 'Error: ' + e.message);
    } finally {
      btnVerify.disabled = false;
      btnVerify.innerHTML = '<i class="bi bi-envelope me-2"></i>Enviar código al correo';
    }
  });

  // Paso 2: valida código temporal + nueva contraseña y ejecuta el restablecimiento.
  btnReset.addEventListener('click', async () => {
    try {
      hideAlert();

      if (!requestPayload) {
        showAlert('warning', 'Primero solicita el código de seguridad.');
        return;
      }

      const code = (resetCodeEl.value || '').trim();
      const p1 = newPasswordEl.value || '';
      const p2 = confirmPasswordEl.value || '';

      if (!code) { showAlert('warning', 'Ingresa el código de seguridad enviado al correo.'); return; }
      if (!p1.trim()) { showAlert('warning', 'Ingresa la nueva contraseña.'); return; }
      if (p1.length < 8) { showAlert('warning', 'La contraseña debe tener mínimo 8 caracteres.'); return; }
      if (!/[A-Za-z]/.test(p1) || !/[0-9]/.test(p1)) {
        showAlert('warning', 'La contraseña debe incluir letras y números.');
        return;
      }
      if (p1 !== p2) { showAlert('warning', 'Las contraseñas no coinciden.'); return; }

      btnReset.disabled = true;
      btnReset.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';

      const r = await postJson('/user/auth/forgot/reset', { ...requestPayload, resetCode: code, newPassword: p1 });

      if (!r.ok) {
        showAlert('danger', r.message || 'No fue posible actualizar la contraseña.');
        return;
      }

      showAlert('success', r.message || 'Contraseña actualizada correctamente. Redirigiendo...');
      setTimeout(() => { window.location.href = '/login/user'; }, 1000);

    } catch (e) {
      showAlert('danger', 'Error: ' + e.message);
    } finally {
      btnReset.disabled = false;
      btnReset.innerHTML = '<i class="bi bi-save me-2"></i>Guardar contraseña';
    }
  });
</script>
</body>
</html>
