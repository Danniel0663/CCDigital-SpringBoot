<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Recuperar contraseña · CCDigital</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/css/ccdigital.css">

  <!-- CSRF (para fetch) -->
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<body class="bg-body-tertiary">
<nav class="navbar cc-navbar">
  <div class="container d-flex justify-content-between align-items-center">
    <span class="navbar-brand fw-semibold cc-brand">
      <i class="bi bi-key me-2"></i>CCDigital · Recuperar contraseña
    </span>
  </div>
</nav>

<main class="container py-5">
  <div class="row justify-content-center">
    <div class="col-12 col-md-8 col-lg-6">
      <div class="cc-card p-4 p-md-5">

        <h1 class="h4 mb-2">Recuperar contraseña</h1>
        <p class="text-muted small mb-3">
          Verifica tu identidad (correo y documento) y luego define una nueva contraseña.
        </p>

        <div id="alertBox" class="alert d-none py-2 mb-3"></div>

        <!-- Paso 1: Verificación -->
        <div id="step1">
          <div class="mb-3">
            <label for="email" class="form-label">Correo</label>
            <input id="email" class="form-control" type="email" autocomplete="email"
                   placeholder="correo@ejemplo.com" required />
          </div>

          <div class="mb-3">
            <label for="idType" class="form-label">Tipo de identificación</label>
            <select id="idType" class="form-select" required>
              <option value="">Selecciona una opción</option>
              <option value="CC">CC</option>
              <option value="CE">CE</option>
              <option value="TI">TI</option>
              <option value="PAS">PAS</option>
              <option value="OTRO">OTRO</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="idNumber" class="form-label">Número de identificación</label>
            <input id="idNumber" class="form-control" type="text" inputmode="numeric"
                   placeholder="Ej: 1234567890" required />
          </div>

          <button id="btnVerify" type="button" class="btn btn-primary w-100">
            <i class="bi bi-shield-check me-2"></i>Verificar identidad
          </button>
        </div>

        <!-- Paso 2: Reset -->
        <div id="step2" class="d-none">
          <div class="alert alert-success py-2 mb-3">
            <i class="bi bi-check-circle me-1"></i>
            Identidad verificada. Define tu nueva contraseña.
          </div>

          <div class="mb-3">
            <label for="newPassword" class="form-label">Nueva contraseña</label>
            <input id="newPassword" class="form-control" type="password" autocomplete="new-password"
                   placeholder="Ingresa tu nueva contraseña" required />
          </div>

          <div class="mb-3">
            <label for="confirmPassword" class="form-label">Confirmar contraseña</label>
            <input id="confirmPassword" class="form-control" type="password" autocomplete="new-password"
                   placeholder="Repite tu nueva contraseña" required />
          </div>

          <button id="btnReset" type="button" class="btn btn-primary w-100">
            <i class="bi bi-save me-2"></i>Guardar contraseña
          </button>
        </div>

        <div class="mt-3 text-center">
          <a href="/login/user" class="small text-decoration-none">
            Volver a iniciar sesión
          </a>
        </div>

      </div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Helpers
  function csrf() {
    const token = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || '';
    const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || 'X-CSRF-TOKEN';
    return { token, header };
  }

  function showAlert(type, msg) {
    const box = document.getElementById('alertBox');
    box.className = 'alert py-2 mb-3 alert-' + type;
    box.textContent = msg;
    box.classList.remove('d-none');
  }

  function hideAlert() {
    const box = document.getElementById('alertBox');
    box.classList.add('d-none');
    box.textContent = '';
  }

  async function postJson(url, data) {
    const { token, header } = csrf();
    const headers = { 'Content-Type': 'application/json' };
    if (token) headers[header] = token;

    const res = await fetch(url, {
      method: 'POST',
      credentials: 'same-origin',
      headers,
      body: JSON.stringify(data)
    });

    if (!res.ok) {
      const txt = await res.text();
      throw new Error('HTTP ' + res.status + ' - ' + txt);
    }
    return res.json();
  }

  // State
  let verifiedPayload = null;

  // Elements
  const step1 = document.getElementById('step1');
  const step2 = document.getElementById('step2');

  const emailEl = document.getElementById('email');
  const idTypeEl = document.getElementById('idType');
  const idNumberEl = document.getElementById('idNumber');

  const newPasswordEl = document.getElementById('newPassword');
  const confirmPasswordEl = document.getElementById('confirmPassword');

  const btnVerify = document.getElementById('btnVerify');
  const btnReset = document.getElementById('btnReset');

  btnVerify.addEventListener('click', async () => {
    try {
      hideAlert();

      const email = (emailEl.value || '').trim();
      const idType = (idTypeEl.value || '').trim();
      const idNumber = (idNumberEl.value || '').trim();

      if (!email) { showAlert('warning', 'Ingresa tu correo.'); return; }
      if (!idType) { showAlert('warning', 'Selecciona el tipo de identificación.'); return; }
      if (!idNumber) { showAlert('warning', 'Ingresa el número de identificación.'); return; }

      btnVerify.disabled = true;
      btnVerify.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Verificando...';

      const r = await postJson('/user/auth/forgot/verify', { email, idType, idNumber });

      if (!r.verified) {
        showAlert('danger', 'No fue posible verificar. Revisa correo y documento.');
        return;
      }

      verifiedPayload = { email, idType, idNumber };
      step1.classList.add('d-none');
      step2.classList.remove('d-none');
      newPasswordEl.focus();

    } catch (e) {
      showAlert('danger', 'Error: ' + e.message);
    } finally {
      btnVerify.disabled = false;
      btnVerify.innerHTML = '<i class="bi bi-shield-check me-2"></i>Verificar identidad';
    }
  });

  btnReset.addEventListener('click', async () => {
    try {
      hideAlert();

      if (!verifiedPayload) {
        showAlert('warning', 'Primero verifica tu identidad.');
        return;
      }

      const p1 = newPasswordEl.value || '';
      const p2 = confirmPasswordEl.value || '';

      if (!p1.trim()) { showAlert('warning', 'Ingresa la nueva contraseña.'); return; }
      if (p1.length < 6) { showAlert('warning', 'La contraseña debe tener mínimo 6 caracteres.'); return; }
      if (p1 !== p2) { showAlert('warning', 'Las contraseñas no coinciden.'); return; }

      btnReset.disabled = true;
      btnReset.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';

      const r = await postJson('/user/auth/forgot/reset', { ...verifiedPayload, newPassword: p1 });

      if (!r.ok) {
        showAlert('danger', 'No fue posible actualizar la contraseña.');
        return;
      }

      // Redirigir directo al login
      window.location.href = '/login/user';

    } catch (e) {
      showAlert('danger', 'Error: ' + e.message);
    } finally {
      btnReset.disabled = false;
      btnReset.innerHTML = '<i class="bi bi-save me-2"></i>Guardar contraseña';
    }
  });
</script>
</body>
</html>