<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registro de Usuario · CCDigital</title>
  <meta name="_csrf" th:content="${_csrf.token}">
  <meta name="_csrf_header" th:content="${_csrf.headerName}">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/css/ccdigital.css">
</head>

<body class="bg-body-tertiary">
<nav class="navbar cc-navbar">
  <div class="container d-flex justify-content-between align-items-center">
    <span class="navbar-brand fw-semibold cc-brand">
      <i class="bi bi-person-plus me-2"></i>CCDigital · Registro Usuario
    </span>
  </div>
</nav>

<main class="container py-5">
  <div class="row justify-content-center">
    <div class="col-12 col-md-8 col-lg-6">
      <div class="cc-card p-4 p-md-5">
        <h1 class="h4 mb-2">Crear cuenta de usuario</h1>
        <p class="cc-help-text small mb-3">
          Completa todos los datos para crear la cuenta.
        </p>

        <div class="cc-hero mb-3">
          <div class="fw-semibold small mb-2">
            <i class="bi bi-lightbulb me-1"></i>Antes de iniciar
          </div>
          <ul class="cc-help-list small">
            <li>El correo que ingreses será tu usuario de acceso.</li>
          </ul>
        </div>

        <div th:if="${error}" class="alert alert-danger py-2 mb-3">
          <i class="bi bi-exclamation-triangle me-1"></i>
          <span th:text="${error}">Error</span>
        </div>

        <div th:if="${success}" class="alert alert-success py-2 mb-3">
          <i class="bi bi-check-circle me-1"></i>
          <span th:text="${success}">Usuario creado</span>
          <div class="small mt-1">
            Correo de acceso:
            <strong th:text="${createdEmail}">correo@ejemplo.com</strong>
          </div>
        </div>

        <div th:if="${showRegisterTotpSetup}" class="cc-form-section mb-3" id="registerTotpPanel"
             th:attr="data-person-id=${registerTotpPersonId},data-otpauth-uri=${registerTotpOtpAuthUri}">
          <div class="cc-section-title">
            <i class="bi bi-phone"></i>Activar autenticador de celular (opcional)
          </div>
          <p class="small text-muted mb-2">
            Tu usuario ya fue creado. Si quieres dejar más seguro el ingreso desde ahora, configura una app autenticadora.
          </p>
          <div class="small mb-2">
            App recomendada: <strong>Aegis</strong> (gratis). También sirve Google Authenticator o Microsoft Authenticator.
          </div>

          <div class="row g-3">
            <div class="col-12 col-md-6">
              <div class="cc-kv-item h-100">
                <div class="cc-kv-label">Clave manual</div>
                <div id="registerTotpSecret" class="cc-kv-value" th:text="${registerTotpSecret}" style="word-break:break-all;">SECRET</div>
                <div class="small text-muted mt-2">Úsala si prefieres ingresar la cuenta manualmente en la app.</div>
              </div>
            </div>
            <div class="col-12 col-md-6">
              <div class="cc-kv-item h-100 d-flex flex-column align-items-center justify-content-center">
                <div class="cc-kv-label mb-2">Código QR</div>
                <div id="registerTotpQrBox" class="bg-white p-2 border rounded" aria-label="QR para app autenticadora"></div>
                <div class="small text-muted mt-2 text-center">Escanea este QR con la app.</div>
              </div>
            </div>
          </div>

          <div id="registerTotpStatus" class="cc-status-box alert py-2 mt-3 mb-0 d-none" role="status" aria-live="polite">
            <span id="registerTotpStatusText">Estado</span>
          </div>

          <div class="row g-2 mt-2">
            <div class="col-12 col-md-8">
              <label for="registerTotpCode" class="form-label">Código generado por la app</label>
              <input id="registerTotpCode" class="form-control" type="text" inputmode="numeric" maxlength="8"
                     placeholder="Código de 6 dígitos" autocomplete="one-time-code">
            </div>
            <div class="col-12 col-md-4 d-flex align-items-end">
              <button id="btnRegisterTotpConfirm" type="button" class="btn btn-primary w-100">
                <i class="bi bi-check2-circle me-1"></i>Activar autenticador
              </button>
            </div>
          </div>
        </div>

        <div th:if="${showRegisterTotpSetup}" class="mt-3 text-center">
          <a href="/login/user" class="small text-decoration-none">
            Ya terminé (o lo haré después). Ir a iniciar sesión
          </a>
        </div>

        <form method="post" th:if="${showRegisterTotpSetup == null or !showRegisterTotpSetup}"
              th:action="@{/register/user}" th:object="${form}">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

          <div class="cc-form-section">
            <div class="cc-section-title">
              <i class="bi bi-card-text"></i>Identificación
            </div>
            <div class="row g-3">
              <div class="col-12 col-md-5">
                <label for="idType" class="form-label">Tipo</label>
                <select id="idType" class="form-select" th:field="*{idType}" required>
                  <option value="">Selecciona una opción</option>
                  <option th:each="t : ${idTypes}" th:value="${t.name()}" th:text="${t.name()}"></option>
                </select>
              </div>
              <div class="col-12 col-md-7">
                <label for="idNumber" class="form-label">Número de identificación</label>
                <input id="idNumber" class="form-control" type="text" inputmode="numeric"
                       th:field="*{idNumber}" placeholder="Ej: 1234567890" required />
              </div>
            </div>
          </div>

          <div class="cc-form-section">
            <div class="cc-section-title">
              <i class="bi bi-person-vcard"></i>Datos personales
            </div>
            <div class="row g-3">
              <div class="col-12">
                <label for="firstName" class="form-label">Nombres</label>
                <input id="firstName" class="form-control" type="text"
                       th:field="*{firstName}" required />
              </div>
              <div class="col-12">
                <label for="lastName" class="form-label">Apellidos</label>
                <input id="lastName" class="form-control" type="text"
                       th:field="*{lastName}" required />
              </div>
              <div class="col-12">
                <label for="birthdate" class="form-label">Fecha de nacimiento</label>
                <input id="birthdate" class="form-control" type="date"
                       th:field="*{birthdate}" required />
              </div>
            </div>
          </div>

          <div class="cc-form-section">
            <div class="cc-section-title">
              <i class="bi bi-envelope-at"></i>Datos de contacto
            </div>
            <div class="row g-3">
              <div class="col-12">
                <label for="email" class="form-label">Correo</label>
                <input id="email" class="form-control" type="email" autocomplete="email"
                       th:field="*{email}" placeholder="correo@ejemplo.com" required />
                <div class="form-text">Este correo será usado para iniciar sesión.</div>
              </div>
              <div class="col-12">
                <label for="phone" class="form-label">Teléfono</label>
                <input id="phone" class="form-control" type="text" inputmode="tel"
                       th:field="*{phone}" required />
              </div>
            </div>
          </div>

          <div class="cc-form-section">
            <div class="cc-section-title">
              <i class="bi bi-shield-lock"></i>Datos de acceso
            </div>
            <div class="row g-3">
              <div class="col-12">
                <label for="password" class="form-label">Contraseña</label>
                <input id="password" class="form-control" type="password" autocomplete="new-password"
                       th:field="*{password}" placeholder="Ingresa una contraseña segura" required />
              </div>
              <div class="col-12">
                <label for="confirmPassword" class="form-label">Confirmar contraseña</label>
                <input id="confirmPassword" class="form-control" type="password" autocomplete="new-password"
                       th:field="*{confirmPassword}" placeholder="Repite la contraseña" required />
              </div>
              <div class="col-12">
                <div class="form-check mt-1">
                  <input id="enableTotpNow" class="form-check-input" type="checkbox" th:field="*{enableTotpNow}" />
                  <label class="form-check-label" for="enableTotpNow">
                    Quiero activar ahora una app autenticadora en mi celular (opcional)
                  </label>
                </div>
                <div class="form-text">
                  Si no la activas ahora, podrás hacerlo después desde tu panel de usuario.
                </div>
              </div>
            </div>
          </div>

          <button type="submit" class="btn btn-primary w-100 mt-3">
            <i class="bi bi-person-check me-2"></i>Crear usuario
          </button>
        </form>

        <div class="mt-3 text-center" th:if="${showRegisterTotpSetup == null or !showRegisterTotpSetup}">
          <a href="/login/user" class="small text-decoration-none">
            Ya tengo cuenta. Ir a iniciar sesión
          </a>
        </div>
      </div>
    </div>
  </div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
  (function () {
    // Si el panel existe, significa que el usuario ya fue creado y está en el paso opcional
    // de activación del autenticador de celular (TOTP) dentro del mismo flujo de registro.
    const panel = document.getElementById('registerTotpPanel');
    if (!panel) return;

    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || '';
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || 'X-CSRF-TOKEN';
    const personId = panel.getAttribute('data-person-id') || '';
    const otpAuthUri = panel.getAttribute('data-otpauth-uri') || '';
    const qrBox = document.getElementById('registerTotpQrBox');
    const codeInput = document.getElementById('registerTotpCode');
    const btnConfirm = document.getElementById('btnRegisterTotpConfirm');
    const statusBox = document.getElementById('registerTotpStatus');
    const statusText = document.getElementById('registerTotpStatusText');

    function setStatus(message, tone) {
      statusText.textContent = message || '';
      statusBox.className = 'cc-status-box is-visible alert py-2 mt-3 mb-0';
      if (tone === 'success') statusBox.classList.add('alert-success');
      else if (tone === 'warning') statusBox.classList.add('alert-warning');
      else if (tone === 'danger') statusBox.classList.add('alert-danger');
      else statusBox.classList.add('alert-info');
    }

    // Genera el QR para que el usuario pueda escanear directamente la cuenta TOTP.
    if (window.QRCode && qrBox && otpAuthUri) {
      qrBox.innerHTML = '';
      try {
        new window.QRCode(qrBox, {
          text: otpAuthUri,
          width: 220,
          height: 220,
          correctLevel: window.QRCode.CorrectLevel.M
        });
      } catch (_) {
        setStatus('No fue posible generar el QR. Puedes usar la clave manual.', 'warning');
      }
    } else {
      setStatus('No se pudo cargar el generador de QR. Puedes usar la clave manual.', 'warning');
    }

    btnConfirm?.addEventListener('click', async function () {
      try {
        const code = (codeInput.value || '').trim();
        if (!code) {
          setStatus('Ingresa el código generado por la app.', 'warning');
          return;
        }
        if (!personId) {
          setStatus('No se encontró el usuario recién creado. Intenta iniciar sesión y actívalo desde el panel.', 'danger');
          return;
        }

        btnConfirm.disabled = true;
        setStatus('Validando código del autenticador...', 'info');

        const headers = { 'Content-Type': 'application/json' };
        if (csrfToken) headers[csrfHeader] = csrfToken;

        const res = await fetch('/register/user/totp/confirm', {
          method: 'POST',
          headers,
          body: JSON.stringify({ personId: Number(personId), code: code })
        });
        const txt = await res.text();
        let data = {};
        try { data = txt ? JSON.parse(txt) : {}; } catch (_) {}
        if (!res.ok) {
          throw new Error((data && (data.error || data.message)) || 'No fue posible activar el autenticador.');
        }

        setStatus((data && data.message) || 'Autenticador activado correctamente. Redirigiendo al inicio de sesión...', 'success');
        btnConfirm.disabled = true;
        codeInput.disabled = true;
        // Una vez confirmado el autenticador, el siguiente paso natural es iniciar sesión.
        // Redirigimos automáticamente para evitar que el usuario quede en una pantalla "quemada".
        setTimeout(function () {
          window.location.href = '/login/user';
        }, 1400);
      } catch (e) {
        setStatus(e.message || 'No fue posible activar el autenticador.', 'danger');
        btnConfirm.disabled = false;
      }
    });
  })();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
